<html>
<head>
<meta charset="UTF-8" />
<link rel="stylesheet" type="text/css" href="../resources/css/footer.css"/>
<script type="text/javascript" src="../resources/javascript/jquery/jquery-2.1.4.min.js">/**/</script>
<link type="text/css" rel="stylesheet" href="../resources/javascript/jquery-ui/jquery-ui.css" />
<script type="text/javascript" src="../resources/javascript/jquery-ui/jquery-ui.min.js">/**/</script>
<link href="../resources/javascript/fancytree/skin-win8/ui.fancytree.min.css" rel="stylesheet" type="text/css">
<script src="../resources/javascript/fancytree/jquery.fancytree-all.min.js" type="text/javascript">/**/</script>
<script type="text/javascript" src="../resources/javascript/jquery.ui-contextmenu/jquery.ui-contextmenu.min.js">/**/</script>
<style type="text/css">
  .ui-menu {
    width: 100px;
    font-size: 63%;
    z-index: 3; /* over ext-wide titles */
  }
</style>
<script type="text/javascript">
	function initialize() {
		$( document ).ready(function() {
			var CLIPBOARD = null;
			$("#tree").fancytree({
				source: JSON.parse(OxygenAddonBuilder.list(window.location.search.substring(13),
					"*.framework, addon.xq, **/target, addon-builder.jar, framework.jar, kuberam-addon-templates.css, **/.svn")),
				minExpandLevel: 2,					
				extensions: ["dnd", "edit"],
				dnd: {
					autoExpandMS: 400,
					focusOnClick: true,
					preventVoidMoves: true,
					preventRecursiveMoves: true,
					dragStart: function(node, data) {
					  return true;
					},
					dragEnter: function(node, data) {
					   return true;
					},
					dragDrop: function(node, data) {
						var sourceNode = data.otherNode;
					  	var operation = OxygenAddonBuilder.move(sourceNode.data.path, node.data.path);
					  	if (operation) {
							console.log(sourceNode.key);
							sourceNode.moveTo(node, data.hitMode);
							sourceNode.data.path =  node.data.path + "/" + sourceNode.title;
							console.log(sourceNode.key);
						}						
					}
				},				
			    edit: {
					triggerStart: ["f2", "dblclick", "shift+click", "mac+enter"],
					beforeEdit: function(event, data) {
					},
					edit: function(event, data){
					},
					beforeClose: function(event, data) {
					},
					save: function(event, data){
						OxygenAddonBuilder.rename(data.node.data.path, data.input.val());
						return true;
					},
					close: function(event, data){
					}
			    }	    
			});
			
			var node = $("#tree").fancytree("getRootNode");
      		//node.sortChildren(null, true);
			
			
			$("#tree").contextmenu({
			  delegate: "span.fancytree-title",
			  menu: [
			  	{title: "Create dir(s)", cmd: "create-directory" },
			  	{title: "Create file", cmd: "create-file" },
				{title: "Edit", cmd: "edit", uiIcon: "ui-icon-pencil" },
				{title: "Delete", cmd: "delete", uiIcon: "ui-icon-trash" },
				{title: "----"},
				{title: "Cut", cmd: "cut", uiIcon: "ui-icon-scissors"},
				{title: "Copy", cmd: "copy", uiIcon: "ui-icon-copy"},
				{title: "Paste", cmd: "paste", uiIcon: "ui-icon-clipboard" }
			  ],
			  beforeOpen: function(event, ui) {
			    var node = $.ui.fancytree.getNode(ui.target);
			    if (node.isFolder()) {
			    	$("#tree").contextmenu("showEntry", "edit", false);
			    	$("#tree").contextmenu("showEntry", "paste", true);
			    } else {
			    	$("#tree").contextmenu("showEntry", "edit", true);
			    	$("#tree").contextmenu("showEntry", "paste", false);
			    }
			    node.setActive();
			  },
			  select: function(event, ui) {
			    var node = $.ui.fancytree.getNode(ui.target);
			    var cmd = ui.cmd;
			    switch (cmd) {
			    	case "create-directory":
		    			var response = prompt("Enter the name of the directory");
		    			var dirNames = response.split('/');
		    			var dirPath = node.data.path;
		    			
				  		for (var i = 0, il = dirNames.length; i < il; i++) {
				  			var dirName = dirNames[i];
				  			dirPath += "/" + dirName;
				  			
						  	var operation = OxygenAddonBuilder.create(dirPath, true);
						  	if (operation) {
								var newNode = node.addNode({"title": dirName, "folder":true, "key": OxygenAddonBuilder.uuid(), "children":[], "data": {"path": dirPath}});
								console.log(newNode.data.path);
								node = newNode;
							}				  			
				  		}    			
			    	break;
			    	case "create-file":
		    			prompt("Enter the name of the file");
			    	break;
			    	case "edit":
		    			OxygenAddonBuilder.edit(node.data.path);
			    	break;			    
			    	case "delete":
			    		var response = confirm("Do you really want to delete this item?");
			    		if (response) {
			    			OxygenAddonBuilder.delete(node.data.path);
			    			node.remove();
							CLIPBOARD = {
							  cmd: "",
							  node: ""
							};			    			
			    		}	
			    	break;
					case "cut":
					  CLIPBOARD = {
					  	cmd: cmd,
					  	node: node
					  };
					  console.log("key = " + node.key);					  
					break;			    	
					case "copy":
					  CLIPBOARD = {
					    cmd: cmd,
					    node: node.toDict(function(n) {
					      delete node.key;
					    })
					  };
					  console.log("key = " + node.key);
					break;
					case "paste":
					  if (CLIPBOARD.cmd === "cut") {
					  	var sourceNode = CLIPBOARD.node;
					  	var operation = OxygenAddonBuilder.move(sourceNode.data.path, node.data.path);
					  	if (operation) {
						    sourceNode.moveTo(node, "child");
						    sourceNode.setActive();
						    sourceNode.data.path = node.data.path + "/" + sourceNode.title;
						}					  	
					  } else if (CLIPBOARD.cmd === "copy") {
					  	var sourceNode = CLIPBOARD.node;
					  	var operation = OxygenAddonBuilder.copy(sourceNode.data.path, node.data.path);
					  	if (operation) {
						    var targetNode = node.addChildren(sourceNode);
						    targetNode.setActive();
						    targetNode.data.path = node.data.path + "/" + CLIPBOARD.node.title;
						    targetNode.key = OxygenAddonBuilder.uuid();
						}		  	
					  }
					break;						
			    }
			    
			  }
			});	
		});		
	}
</script>
</head>
<body onload="window.setTimeout(initialize, 0);">
	<h2>Manage framework</h2>
	<ol id="tree"></ol>
	<div id="footer">
		<button style="float: right;" onclick="OxygenAddonBuilder.closeDialogWindow();">Close</button>
	</div>
</body>
</html>
